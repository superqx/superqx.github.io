{% assign current_lang = site.active_lang %}
{% assign current_url = page.url %}
{% assign path_parts = current_url | remove_first: '/' | split: '/' %}

{% comment %}
  If current_lang is default, nothing to remove.
  If not default, remove the lang code from URL.
{% endcomment %}
{% if current_lang == site.default_lang %}
  {% assign stripped_path = current_url %}
{% else %}
  {% assign stripped_path = '/' | append: path_parts | slice: 1, path_parts.size | join: '/' %}
{% endif %}

<div class="language-switcher">
  {% for lang in site.languages %}
    {% unless lang == current_lang %}
      {% if lang == site.default_lang %}
        <a href="{{ stripped_path }}">
      {% else %}
        <a href="/{{ lang }}{{ stripped_path }}">
      {% endif %}
        <img src="{{ '/assets/flags/' | append: lang | append: '.png' }}" alt="{{ lang }} flag" width="24" height="16">
      </a>
    {% endunless %}
  {% endfor %}
</div>
